# CF1446D2

ç»™å®šä¸€ä¸ªæ•°ç»„ $ [a_1, a_2, \dots, a_n] $ ã€‚

æ‚¨çš„ç›®æ ‡æ˜¯æ‰¾åˆ°è¿™ä¸ªæ•°ç»„çš„æœ€é•¿å­æ•°ç»„çš„é•¿åº¦ï¼Œä½¿å¾—å…¶ä¸­æœ€é¢‘ç¹çš„å€¼**ä¸**æ˜¯å”¯ä¸€çš„ã€‚æ¢å¥è¯è¯´ï¼Œæ‚¨è¦æ‰¾åˆ°ä¸€ä¸ªå­æ•°ç»„ï¼Œä½¿å¾—å¦‚æœè¿™ä¸ªå­æ•°ç»„ä¸­æœ€é¢‘ç¹çš„å€¼å‡ºç° $ f $ æ¬¡ï¼Œé‚£ä¹ˆè‡³å°‘ä¼šæœ‰ $ 2 $ ä¸ªä¸åŒçš„å€¼æ°å¥½å‡ºç° $ f $ æ¬¡ã€‚

å¦‚æœ $ c $ æ˜¯æ•°ç»„ $ d $ çš„å­æ•°ç»„ï¼Œåˆ™ $ c $ å¯ä»¥é€šè¿‡ä»å¼€å¤´åˆ é™¤è‹¥å¹²ï¼ˆå¯èƒ½æ˜¯é›¶æˆ–å…¨éƒ¨ï¼‰å…ƒç´ å’Œä»ç»“å°¾åˆ é™¤è‹¥å¹²ï¼ˆå¯èƒ½æ˜¯é›¶æˆ–å…¨éƒ¨ï¼‰å…ƒç´ æ¥è·å¾—ã€‚

$n\le 2\times 10^5,a_i\le n$

### æ€è€ƒ

æœ‰ä»€ä¹ˆå¥½çš„åŠæ³•åˆ¤æ–­ä¸€ä¸ªåŒºé—´æ˜¯å¦åˆæ³•å—ï¼Ÿè¿™ä¸ªä¼—æ•°è¿˜æ˜¯å¤ªæŠ½è±¡äº†

D1 ç‰ˆæœ¬çš„å€¼åŸŸæ˜¯ $100$ï¼Œè¿™æ„å‘³ç€åšæ³•å’Œå€¼åŸŸæœ‰å…³ï¼Œä¸ä¼šæœ‰æ²¡ç”¨çš„çº¦æŸã€‚

å¦‚æœæˆ‘æšä¸¾ä¼—æ•°çš„å‡ºç°æ¬¡æ•° $x$

é‚£ä¹ˆå¯¹äºæ¯ä¸ªå€¼ï¼Œä½¿å¾—ä»–å‡ºç° $x$ æ¬¡çš„åŒºé—´æ˜¯å¯ä»¥åˆ»ç”»çš„ï¼Œè‡³å°‘è¦åŒ…å«ä¸¤ä¸ªå€¼çš„åŒºé—´ã€‚

æœ‰ç‚¹å›°éš¾

å€¼åŸŸ 100 æ€ä¹ˆåšï¼Ÿ

è¿˜æ˜¯å›°éš¾ï¼Œæƒ³ä¸åˆ°ä»€ä¹ˆæ€è·¯äº†

### é¢˜è§£	

éå¸¸å…³é”®çš„ç»“è®ºï¼šè‹¥åŸåºåˆ—çš„ä¼—æ•°ä¸º $X$ï¼Œç­”æ¡ˆå­æ®µçš„ä¼—æ•°é›†åˆä¸€å®šå«æœ‰ $X$ã€‚

è¯æ˜æ˜¯ï¼Œè‹¥ç­”æ¡ˆå­æ®µçš„ä¼—æ•°ä¸å« $X$ï¼Œè¯´æ˜å­æ®µå†… $X$ çš„å‡ºç°æ¬¡æ•°å°äºå­æ®µä¼—æ•°ã€‚é‚£ä¹ˆå¯ä»¥å‘ä¸¤ä¾§æ‹“å±•ï¼Œå®¹æ˜“è¯æ˜ä¸€å®šèƒ½æ‹“å±•åˆ°ä¸€ä¸ªåˆæ³•çš„æ›´å¤§åŒºé—´ï¼Œæ»¡è¶³ $X$ æˆä¸ºå­æ®µçš„ä¼—æ•°ã€‚

äºæ˜¯ç°åœ¨å¯åšéå¸¸å¤šï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå°½å¯èƒ½é•¿çš„å­æ®µï¼Œæ»¡è¶³ $X$ ä¸å¦ä¸€ä¸ªæ•°çš„å‡ºç°æ¬¡æ•°ç›¸ç­‰ã€‚å¦‚æœ $X$ ä¸çœŸçš„æ˜¯è¿™ä¸ªåŒºé—´çš„ä¼—æ•°æ˜¯æ²¡å…³ç³»çš„ï¼Œå› ä¸ºè¿™æ ·çš„åŒºé—´ä¸ä¼˜ï¼Œæ¢æˆ $X$ ä¸çœŸæ­£çš„ä¼—æ•°å¯ä»¥å¾—åˆ°æ›´å¤§çš„ç­”æ¡ˆã€‚

äºæ˜¯ç°åœ¨æœ‰äº†ä¸€ä¸ªæšä¸¾å€¼åŸŸçš„åšæ³•ã€‚å¯¹äºæ¯ä¸ªå€¼ $V$ï¼ŒæŠŠ $X$ çœ‹æˆ $+1$ï¼Œ$V$ çœ‹æˆ $-1$ï¼Œæ‰¾åŒºé—´å’Œä¸º $0$ çš„æœ€é•¿å­æ®µå³å¯ï¼Œéœ€è¦èŠ±è´¹ $O(occ(X)+occ(V))$ çš„æ—¶é—´ã€‚

æ³¨æ„åˆ°ï¼Œç¬¦åˆè¦æ±‚çš„å­æ®µåŒ…å«çš„ $X$ æ•°é‡æ˜¯å’Œ $V$ ç›¸ç­‰çš„ã€‚**å½“ $X$ çš„å‡ºç°æ¬¡æ•°è¿œå¤šäº $V$ æ—¶ï¼Œæšä¸¾ $occ(X)$ æ˜¾å¾—æœ‰äº›æµªè´¹**ã€‚

å°è¯•åªä¿ç•™ $O(occ(V))$ ä¸ª $X$ å¹¶ä¸”ä¸å½±å“ç­”æ¡ˆã€‚è€ƒè™‘ $V$ ä¸ $X$ é…å¯¹ã€‚

- ä»å‰å¾€åéå† $V$ï¼ŒæŠŠå®ƒä¸åé¢ç¬¬ä¸€ä¸ª $X$ é…å¯¹ï¼Œåˆ å» $X$
- ä»åå¾€å‰éå† $V$ï¼ŒæŠŠå®ƒä¸å‰é¢ç¬¬ä¸€ä¸ª $X$ é…å¯¹ï¼Œåˆ å» $X$

æ˜¾ç„¶ $X$ çš„æ•°é‡ç¬¦åˆè¦æ±‚ï¼Œä¸”å¯ä»¥è¯æ˜ï¼Œåªè€ƒè™‘è¢«é…å¯¹çš„ $X$ ç­”æ¡ˆä¸å˜ã€‚

>  å¯¹äºæœªè¢«é…å¯¹çš„ $X$ï¼Œå®ƒä¸€å®šä¸ä¼šåœ¨ç­”æ¡ˆä¸­å‡ºç°ã€‚

å¯¹äºä¸€ä¸ªæœªè¢«é…å¯¹çš„ $X$ï¼Œæˆ‘ä»¬å‘åæ‹“å±•ï¼ˆå‘å‰åŒç†ï¼‰ï¼Œå¸Œæœ›æ‰¾åˆ°ä¸€ä¸ª $V$ èƒ½è´¡çŒ®ä¸€ä¸ª $-1$ ä½¿å¾—åŒºé—´å’Œä¸º $0$ã€‚ä½†å®ƒåé¢ä¸€å®šæ²¡æœ‰æœªå‘å‰é…å¯¹çš„ $V$ï¼Œå› æ­¤æ¯ä¸ª $V$ åœ¨è¢«è®¿é—®åˆ°ä¹‹å‰ï¼Œå®ƒçš„ $-1$ ä¸€å®šä»¥åŠè¢«å®ƒå‘å‰åŒ¹é…çš„ $X$ æŠµæ¶ˆæ‰äº†ã€‚

ç›´æ¥ç»´æŠ¤å³å¯ï¼Œå¤æ‚åº¦ $O(n\log n)$ã€‚ç²¾ç»†å®ç°å¯ä»¥åšåˆ° $O(n)$ï¼Œä¸è¿‡æ²¡æœ‰å¿…è¦ã€‚

```
int n;
int a[MAXN];
int getX(){
	static int cnt[MAXN];
	foru(i,1,n){
		cnt[a[i]]++;
	}
	
	int mx=0,ct=0;
	ford(i,n,1){
		if(cnt[i]>mx){
			mx=cnt[i];
			ct=1;
		}else if(cnt[i]==mx){
			ct++;
		}
	}
	if(ct>1){
		cout<<n;
		exit(0);
	}

	foru(i,1,n){
		if(mx==cnt[i])	return i;
	}
	exit(1);
}
void solve(bool SPE){ 
	n=RIN;
	foru(i,1,n){
		a[i]=RIN;
	}

	int X=getX();
	cerr<<X<<endl;

	static vector<int> ls[MAXN];
	foru(i,1,n){
		ls[a[i]]+=i;
	}

	static set<int> xls;
	foru(i,1,n){
		if(a[i]==X)	xls+=i;
	}

	int ans=0;
	foru(v,1,n){
		if(ls[v].empty())	continue;
		if(v==X)	continue;

		static vector<int> p;
		static vector<int> rmv;
		
		p=ls[v];
		
		for(auto i:ls[v]){
			auto it=xls.lower_bound(i);
			if(it==xls.end())	break;
			rmv+=*it;
			p+=*it;
			xls.erase(it);
		}
		for(int i=ls[v].size()-1;i>=0;i--){
			auto it=xls.lower_bound(ls[v][i]);
			// cerr<<i<<' '<<*it<<endl;
			if(it==xls.begin())	break;
			it--;
			rmv+=*it;
			p+=*it;
			xls.erase(it);
		}
		sort(All(p));

		// cein<<p<<endl;

		for(size_t l=0;l<p.size();){
			size_t r=l;

			auto ptr=xls.lower_bound(p[l]);
			int lm=n+1;
			if(ptr!=xls.end())	lm=*ptr;
			while(r+1<p.size() && p[r+1]<lm)	r++;
			
			static unordered_map<int,int> bg;
			bg.clear();
			bg[0]=0;
			if(ptr!=xls.begin())	bg[0]=*prev(ptr);

			int s=0;
			for(size_t i=l;i<=r;i++){
				if(a[p[i]]==X){
					s++;
				}else{
					s--;
				}
				// cerr<<X<<' '<<v<<' '<<p[i]<<' '<<s<<endl;
				// cerr<<r<<' '<<i<<endl;
				auto it=bg.find(s);
				if(it!=bg.end()){
					int R=lm;
					if(i+1<=r)	R=p[i+1];
					// cerr<<R<<' '<<it->se<<endl;
					chkmax(ans,R-1-it->se);
				}else{
					bg[s]=p[i];
				}
			}

			l=r+1;
		}

		for(auto i:rmv){
			xls+=i;
		}
		rmv.clear();

		cerr<<"~"<<ans<<endl;
	}

	cout<<ans;
	return ;
}
```

# AT_agc016_e

æœ‰$N$åªç«é¸¡ã€‚æˆ‘ä»¬ç”¨$1$åˆ°$N$å¯¹å®ƒä»¬ç¼–å·ã€‚

$M$ä¸ªäººå°†ä¾æ¬¡åˆ°è¾¾è¿™é‡Œã€‚ç¬¬$i$ä¸ªåˆ°è¾¾çš„äººå°†é‡‡å–ä»¥ä¸‹è¡ŒåŠ¨ï¼š

- å¦‚æœç«é¸¡$x_i$å’Œ$y_i$éƒ½è¿˜æ´»ç€ï¼šç­‰æ¦‚ç‡é€‰æ‹©å…¶ä¸­ä¸€åªï¼Œç„¶ååƒæ‰ã€‚
- å¦‚æœç«é¸¡$x_i$æˆ–$y_i$ä¸­çš„ä¸€åªè¿˜æ´»ç€ï¼ˆä½†ä¸æ˜¯åŒæ—¶ï¼‰ï¼šåƒæ‰è¿˜æ´»ç€çš„é‚£åªã€‚
- å¦‚æœç«é¸¡$x_i$å’Œ$y_i$éƒ½å·²ä¸å†æ´»ç€ï¼šä¸åšä»»ä½•äº‹æƒ…ã€‚

æ‰¾åˆ°æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„å¯¹$(i,\ j)$çš„æ•°é‡ï¼ˆ$1 â‰¤ i < j â‰¤ N$ï¼‰ï¼š

- åœ¨æ‰€æœ‰äººé‡‡å–è¡ŒåŠ¨åï¼Œç«é¸¡$i$å’Œ$j$éƒ½è¿˜æ´»ç€çš„æ¦‚ç‡å¤§äº$0$ã€‚



-   $2 â‰¤ N â‰¤ 400$
-   $1 â‰¤ M â‰¤ 10^5$
-   $1 â‰¤ x_i \lt y_i â‰¤ N$

### æ€è€ƒ

å¦‚æœæŠŠ $x_i$ å’Œ $y_i$ è¿è¾¹ä¼šå‘ç”Ÿä»€ä¹ˆ 

å¯¹äºä¸€ä¸ª $i$ $j$ çš„è¯¢é—®ï¼Œç›¸å½“äºæˆ‘è¦ä¿æ´»ä»–ä»¬ã€‚å¯¹äºä¸ä»–ä»¬ç›´æ¥ç›¸è¿çš„è¾¹ï¼Œè¿™ä¸ªè¾¹çš„å¦ä¸€ç«¯çš„ç«é¸¡å¿…é¡»ç”±è¿™ä¸ªè¾¹æ€ï¼Œè¿™å¤šå‡ºæ¥äº†ä¸€äº›ç¡®å®šæ€§ã€‚

ç›¸å½“äºæŠŠè¾¹çš„å¦ä¸€ä¸ªç«¯ç‚¹å’Œè¿™ä¸ªè¾¹é…å¯¹äº†

é‚£ä¹ˆå¯¹äºå¦ä¸€ä¸ªç«¯ç‚¹å†è¿å‡ºå»çš„è¾¹ï¼Œå¿…é¡»å†å’Œå¦ä¸€ä¸ªç«¯ç‚¹é…å¯¹

å¦‚æœä¸€ä¸ªç«¯ç‚¹ä¸å¾—ä¸å’Œä¸¤ä¸ªè¾¹é…å¯¹å°±çˆ†äº†ã€‚

å¦‚æœä¸€ä¸ªè¾¹çš„ä¸¤ä¸ªç«¯ç‚¹éƒ½å’Œåˆ«äººé…å¯¹äº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

è¿™é‡Œä¼¼ä¹æœ‰ä¸€ä¸ªé™åˆ¶ï¼šè¿™ä¸ªè¾¹çš„æ“ä½œæ—¶é—´å¿…é¡»æ™šäºå®ƒä¸¤ä¸ªç«¯ç‚¹é…å¯¹è¾¹çš„æ“ä½œæ—¶é—´ï¼Œå¦åˆ™ä¹Ÿå¾—çˆ†äº†

è¿™ä¼¼ä¹å·²ç»æ˜¯ä¸€ä¸ªå……è¦æ¡ä»¶ï¼Œå¦‚æœç¬¦åˆè¿™ä¸ªæƒ…å½¢ï¼Œä¸€å®šèƒ½æ„é€ æ–¹æ¡ˆï¼Œåä¹‹ï¼Œå¯¹äºæ‰€æœ‰çš„æ“ä½œåºåˆ—ï¼ŒæŸç§æ„ä¹‰ä¸Šå¿…ç„¶æ»¡è¶³è¿™ç§æƒ…å½¢

è¿™ä¼¼ä¹ä¸æ˜¯ä¸€ä¸ªå›ºå®šçš„æ“ä½œ

å¯¹äºä¸ $ij$ ç›´æ¥ç›¸è¿çš„è¾¹æ˜¯ç¡®å®šçš„ï¼Œå¿…é¡»æœå¤–ï¼Œå› ä¸ºéœ€è¦ä¿æ´»ç›®æ ‡ç«é¸¡ã€‚è¿™ä¸ªæ—¶å€™å°±åº”è¯¥æ‰§è¡Œä¸€äº›æ£€æŸ¥ï¼Œå¦‚æœä¸€ä¸ªç«¯ç‚¹è¢«äºŒè€…åŒæ—¶éœ€è¦å°±çˆ†äº†ï¼Œå¦‚æœä¸€ä¸ªè¾¹çš„ä¸¤ç«¯ç‚¹éƒ½å·²ç»è¢«é…å¯¹ï¼Œä¸”è¿™ä¸ªè¾¹çš„æ“ä½œæ—¶é—´ä¸æ˜¯æœ€æ™šçš„ä¹Ÿçˆ†äº†ã€‚

å‰©ä¸‹çš„è¾¹çš„åˆ†é…ä¼¼ä¹æ˜¯å¯å˜çš„ï¼Œæˆ‘éœ€è¦æƒ³åŠæ³•åˆ†é…ï¼Œå°½å¯èƒ½ä½¿å…¶ä¸çˆ†ï¼Œçµæ´»çš„åˆ†é…ä¼šå½±å“æœ‰å“ªäº›è¾¹è¢«å¤¹åœ¨é…å¯¹ç‚¹ä¹‹é—´çš„checkã€‚

ä¸å¦¨ç§°ç¡®å®šæ€§çš„è¾¹ä¸º â€œå›ºå®šè¾¹â€ã€‚ä¸€å¼€å§‹çš„å›ºå®šè¾¹åªæœ‰ç›´æ¥å’Œ $ij$ ç›¸è¿çš„è¾¹

å¦‚æœä¸€ä¸ªéå›ºå®šè¾¹ä¸å›ºå®šè¾¹ç›¸é‚»ï¼Œä¸”éå›ºå®šè¾¹çš„æ“ä½œæ—¶é—´æ›´æ—©ï¼Œé‚£è¿™ä¸ªéå›ºå®šè¾¹ä¸€å®šè¢«å›ºå®šäº†ã€‚å› ä¸ºè¿™ä¸ªéå›ºå®šè¾¹çš„checkä¸€å®šä¼šçˆ†ï¼Œä¸ºäº†ä¸çˆ†è‚¯å®šä¼šæŠŠå®ƒå«è¿›æ¥ã€‚

ç›´æ¥è¿™æ ·æ‰©å±•åˆ°æå¤§ä¹‹åï¼Œä¸æ‰©å±•è‚¯å®šæœ€ä¼˜äº†ï¼Œç›´æ¥checkå³å¯ã€‚

æœ´ç´ å®ç°çš„å¤æ‚åº¦åº”è¯¥æ˜¯ $O(n^2(n+m))$ çš„ï¼Ÿ

ç²¾ç»†å®ç°å¯èƒ½æ˜¯ $O(n^3)$ çš„ã€‚å…ˆä¸ç®¡

å¯¹äºæ¯ä¸ªç‚¹å…ˆè·‘ä¸€ä¸ªæœ€å°çš„å›ºå®šè¾¹è”é€šå—å‡ºæ¥ï¼Œå¦‚æœç‚¹å¯¹ç‚¹é›†æœ‰äº¤å°±çˆ†ç‚¸äº†ã€‚è¿™ä¸ªæ˜¯å¯ä»¥ $O(\frac{n^3}{w})$ çš„ã€‚

è¾¹æ€ä¹ˆåŠï¼Ÿ

è¾¹çš„æ•°é‡æ˜¾ç„¶ä¹Ÿæ˜¯ $O(n)$ çš„ï¼æˆ‘ä»¬åªéœ€è¦è€ƒè™‘å’Œè”é€šå—ç›´æ¥ç›¸è¿çš„è¾¹å°±è¡Œäº†ã€‚

å¤æ‚åº¦å¯ä»¥åšåˆ° $O(n^3+nm)$ï¼Œåº”è¯¥æ˜¯ T ä¸äº†çš„ã€‚

### Accept

è¿‡äº†ğŸ˜‹ï¸ğŸ˜‹ï¸ğŸ˜‹ï¸

é¢˜è§£åŸºæœ¬ä¹Ÿæ˜¯ $O(n^3+nm)$

```
int n,m;
vector<pair<int,int>> e[405];

void solve(bool SPE){ 
	n=RIN,m=RIN;
	foru(i,1,m){
		int u=RIN,v=RIN;
		e[u]+=mkp(v,i);
		e[v]+=mkp(u,i);
	}

	static bitset<405> in[405];
	static int opt[405][405];
	static bool fail[405];
	static vector<pair<int,int>> els[405];
	foru(i,1,n){
		in[i][i]=1;
		opt[i][i]=INT_MAX;
		auto dfs=[&i](auto dfs,int u,int T)->void {
			for(auto [v,t]:e[u]){
				if(in[i][v])	continue;
				if(t<T){
					in[i][v]=1;
					opt[i][v]=t;
					dfs(dfs,v,t);
				}
			}
		};
		for(auto [v,t]:e[i]){
			if(in[i][v]){
				fail[i]=1;
				goto fail;
			}
			in[i][v]=1;
			opt[i][v]=t;
		}
		for(auto [v,t]:e[i]){
			dfs(dfs,v,t);
		}
		foru(u,1,n){
			if(!in[i][u])	continue;
			for(auto [v,t]:e[u]){
				if(in[i][v]){
					if(t==opt[i][u] || t==opt[i][v])	continue;
					if(t<opt[i][u] || t<opt[i][v]){
						fail[i]=1;
						goto fail;
					}
				}else{
					if(t<opt[i][u]){
						fail[i]=1;
						goto fail;
					}
					els[i]+=mkp(v,t);
				}
			}
		}
		
		fail:;
	}

	int ans=0;
	foru(i,1,n){
		if(fail[i])	continue;
		foru(j,i+1,n){
			if(fail[j])	continue;
			if((in[i]&in[j]).count())	continue;
			
			for(auto [v,t]:els[i]){
				if(!in[j][v])	continue;
				if(t<opt[j][v])	goto chkfail;
			}
			for(auto [v,t]:els[j]){
				if(!in[i][v])	continue;
				if(t<opt[i][v])	goto chkfail;
			}
			ans++;
			chkfail:;
		}
	}
	cout<<ans;
	
	return ;
}
```



# P6631

Bob å–œæ¬¢åºåˆ—ã€‚

æœ‰ä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„éè´Ÿæ•´æ•°åºåˆ— $a_1, a_2,\cdots, a_n$ã€‚æ¯ä¸€æ­¥ä½ å¯ä»¥ä»ä»¥ä¸‹ä¸‰ç§æ“ä½œä¸­é€‰æ‹©ä¸€ç§æ‰§è¡Œï¼š

- é€‰æ‹©ä¸€ä¸ªåŒºé—´ $[l, r]$ï¼Œå°†ä¸‹æ ‡åœ¨è¿™ä¸ªåŒºé—´é‡Œçš„æ‰€æœ‰æ•°éƒ½å‡ $1$ã€‚

- é€‰æ‹©ä¸€ä¸ªåŒºé—´ $[l, r]$ï¼Œå°†ä¸‹æ ‡åœ¨è¿™ä¸ªåŒºé—´é‡Œä¸”ä¸‹æ ‡ä¸ºå¥‡æ•°çš„æ‰€æœ‰æ•°éƒ½å‡ $1$ã€‚

- é€‰æ‹©ä¸€ä¸ªåŒºé—´ $[l, r]$ï¼Œå°†ä¸‹æ ‡åœ¨è¿™ä¸ªåŒºé—´é‡Œä¸”ä¸‹æ ‡ä¸ºå¶æ•°çš„æ‰€æœ‰æ•°éƒ½å‡ $1$ã€‚

æ±‚æœ€å°‘éœ€è¦å¤šå°‘æ­¥æ‰èƒ½å°†åºåˆ—ä¸­çš„æ‰€æœ‰æ•°éƒ½å˜æˆ $0$ã€‚

å¯¹äº 100% çš„æ•°æ®ï¼Œ$1 \leq n \leq 100000, 0 \leq ai \leq 10^9, 1 \leq T \leq 10$ã€‚

### æ€è€ƒ

é¡ºç€ç›´æ¥DPä»€ä¹ˆçš„ä¼¼ä¹æœ‰ç‚¹å®Œè›‹ï¼Œä½†ä¹Ÿä¸å¥½è¯´

æœ‰ä»€ä¹ˆæ€§è´¨æˆ–è€…è½¬åŒ–ä¹ˆï¼Ÿ

æˆ‘ä»¬éœ€è¦ç¼©å°å†³ç­–èŒƒå›´

å¦‚æœä¸€ä¸ªæ“ä½œä¸€ä¸¤ä¾§å„è‡ªç´§è·Ÿäº†æ“ä½œäºŒ / æ“ä½œä¸‰ï¼Œè‚¯å®šä¸ä¼˜ï¼Œå¯ä»¥æ›¿æ¢ä¸ºä¸€ä¸ªæ“ä½œäºŒå’Œä¸€ä¸ªæ“ä½œä¸‰æ‹¼èµ·æ¥ã€‚

å¦‚æœåªæœ‰ä¸€è¾¹æœ‰ï¼Œæ›¿æ¢æ‰ä¹Ÿæ˜¯ä¸åŠ£çš„ã€‚

è¯´æ˜å¯¹äºä»»ä½•ä¸€ä¸ªæ“ä½œä¸€ $[l,r]$ ï¼Œä¸å­˜åœ¨ä»¥ $l-1$ ä¸ºå³ç«¯ç‚¹çš„ã€æˆ–ä»¥ $r+1$ ä¸ºå·¦ç«¯ç‚¹çš„ä»»ä½•æ“ä½œã€‚

æ“ä½œæ˜¯èƒ½äº¤æ¢çš„ï¼ŒæŠŠæ“ä½œä¸€æ”¾æœ€åï¼Ÿæ”¾æœ€å¼€å§‹ï¼Ÿéƒ½æœ‰ç‚¹æŠ½è±¡å•Š

### é¢˜è§£

æˆ‘è¶£ï¼Œçº¿æ€§è§„åˆ’å¯¹å¶ï¼



#### çº¿æ€§è§„åˆ’

å­¦åˆ°äº†ä¸€ç§[æ›´å¥½çš„æœºæ¢°å¼çº¿æ€§è§„åˆ’å¯¹å¶æµç¨‹](https://www.cnblogs.com/yyyyxh/p/17939643/LPdual)ï¼Œå¾ˆçµæ´»çš„ä¸€ç§æ–¹æ³•ã€‚



é¦–å…ˆæŠŠæ‰€æœ‰çš„ä¸ç­‰å¼é™åˆ¶éƒ½åŒ–ä½œ $\le 0$ çš„å½¢å¼ã€‚è¿™ä¸€æ­¥å¯ä»¥ç®€å•ç§»é¡¹å®Œæˆã€‚

ç„¶åä¸ºæ¯ä¸ªé™åˆ¶ï¼š

- å¼•å…¥ä¸€ä¸ªå› å­ $\lambda_i$
- å°†é™åˆ¶çš„å·¦ä¾§å¼å­æ•´ä½“ä¹˜ $\lambda _i$ ä¹‹ååŠ åˆ°æœ€ä¼˜åŒ–ç›®æ ‡å‡½æ•°ä¸Š

ä¹‹åè¿˜éœ€è¦ä¸ºæ¯ä¸ª $\lambda _i$ å¼•å…¥å®ƒçš„çº¦æŸã€‚å¯¹äºæ¯ä¸ª $\lambda _i$ï¼š

- å¦‚æœå¯¹åº”çš„é™åˆ¶æ˜¯ç­‰å¼ï¼Œä¸ä¸º $\lambda _i$ æ·»åŠ çº¦æŸ
- å¦‚æœå¯¹åº”çš„é™åˆ¶æ˜¯ä¸ç­‰å¼ï¼Œä¸”æœ€ä¼˜åŒ–ç›®æ ‡æ˜¯ $\min$ ï¼Œåˆ™æ·»åŠ  $\lambda _i\ge 0$ï¼Œå¦åˆ™æ·»åŠ  $\lambda _i \le 0$



ç°åœ¨æˆ‘ä»¬çš„æœ€ä¼˜åŒ–ç›®æ ‡å‡½æ•°å˜æˆäº†ä¸€ä¸ªå…³äº $x$ å’Œ $\lambda$ çš„å¤šå…ƒå‡½æ•° $L(x,\lambda)$ã€‚

è€ƒè™‘ç”¨ä¸‹é¢è¿™ä¸ªå¼å­æ¥åœ¨æœ¬è´¨ä¸Šè¾…åŠ©æˆ‘ä»¬è¿›è¡Œä¸‹é¢çš„å·¥ä½œï¼šåœ¨æœ€ä¼˜åŒ–å‡½æ•°å‰é¢è¡¥å……**ä¸ä½ çš„æœ€ä¼˜åŒ–æ–¹å‘ç›¸åçš„** $\min_{\lambda}$ / $\max_{\lambda}$

- è‹¥ä½ çš„æœ€ä¼˜åŒ–ç›®æ ‡ä¸º $\min_{x}L(x,\lambda)$ï¼Œæˆ‘ä»¬å¾—åˆ° $\max_{\lambda}\min_{x}L(x,\lambda)$
- è‹¥ä½ çš„æœ€ä¼˜åŒ–ç›®æ ‡ä¸º $\max_{x}L(x,\lambda)$ï¼Œæˆ‘ä»¬å¾—åˆ° $\min_{\lambda}\max_{x}L(x,\lambda)$



ä»¥ç¬¬ä¸€ä¸ªå¼å­ä¸ºä¾‹ï¼Œå»æŠŠè¿™ä¸ª $\max\min$ çš„è¿‡ç¨‹æƒ³è±¡ä¸ºä¸€ä¸ªäºŒäººæ¸¸æˆã€‚é‡Œé¢äººçš„ç›®æ ‡æ˜¯æœ€å°åŒ– $L(x,\lambda)$ï¼Œè€Œå¤–å±‚çš„äººçš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–ã€‚å¤–å±‚çš„äººéœ€è¦é€šè¿‡ $\lambda$ çš„é€‰å–æ¥é™åˆ¶å†…å±‚äººçš„è¡ŒåŠ¨ã€‚

ä¸€ä¸ªç¡¬æ€§éœ€æ±‚æ˜¾ç„¶æ˜¯éœ€è¦é˜»æ­¢å†…å±‚çš„ $\min$ ç©å®¶æˆåŠŸåˆ°è¾¾ $-\infty$ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬æŠŠ $L(x,\lambda)$ æ•´ç†ä¸º $x$ ä¸»å…ƒçš„å½¢å¼ï¼Œå¹¶æå–ç³»æ•°ã€‚

è€ƒè™‘ $L(x,\lambda)$ ä¸­ $x_i$ çš„ç³»æ•° $t_i$ï¼Œå…¶ä¸­ $t_i$ ç†åº”æ˜¯ä¸€ä¸ª $\lambda$ çš„çº¿æ€§ç»„åˆã€‚è‹¥ $x_i\ge0$ï¼Œåˆ™ $t_i$ æ˜¾ç„¶å¿…é¡»éè´Ÿï¼Œå¦åˆ™å†…å±‚ç©å®¶å°±å¯ä»¥é å®ƒè¾¾åˆ° $-\infty$ã€‚ç±»ä¼¼åœ°ï¼Œå¯ä»¥æ¨å‡ºå½“ $x_i=0$ã€$x_i\le 0$ æ—¶ $t_i$ åº”è¯¥åˆ†åˆ«ä¸º $0$ã€éæ­£ã€‚

åŒæ—¶ï¼Œ$L(x,\lambda)$ ä¸­æ˜¾ç„¶ä¼šå­˜åœ¨ä¸ $x$ æ— å…³çš„é¡¹ï¼ŒæŠŠä»–ä»¬ä»å†…å±‚çš„ $\min$ ä¸­æåˆ° $\max$ é‡Œæ¥ï¼Œå¹¶ç›´æ¥ä¸¢å¼ƒå†…å±‚çš„ $\min$ï¼Œå°±å¾—åˆ°äº†å¯¹å¶åçš„ç»“æœï¼š

- å˜é‡æ˜¯ $\lambda$ï¼šå®ƒä»¬æ˜¯ç”±åŸé—®é¢˜çš„æ¯ä¸ªé™åˆ¶å¼•å…¥çš„ã€‚
- $\lambda$ çš„ç‰¹æ®Šé™åˆ¶ï¼ˆ$\ge 0$ ç­‰ï¼‰ï¼šå®ƒä»¬æ˜¯ç”±åŸé—®é¢˜æ¯ä¸ªé™åˆ¶çš„å½¢å¼å’Œæœ€ä¼˜åŒ–æ–¹å‘å†³å®šçš„
- $\lambda$ çš„çº¦æŸï¼šå®ƒä»¬æ˜¯ç”±åŸé—®é¢˜çš„é™åˆ¶ä¸åŸæœ€ä¼˜åŒ–å‡½æ•°ç»„åˆå¾—åˆ°çš„
- æ–°çš„æœ€ä¼˜åŒ–ç›®æ ‡ï¼šå®ƒä»¬æ˜¯ç”±åŸé—®é¢˜çš„é™åˆ¶ç»„åˆå¾—åˆ°çš„

å®¹æ˜“å‘ç°è¿™æ ·ä¸çŸ©é˜µè½¬ç½®çš„æœ¬è´¨ç›¸åŒï¼Œä½†é¿å…äº†å¾ˆå¤šç¹æ‚çš„æ“ä½œã€‚



ç”¨è¿™ä¸ªé—®é¢˜ç»ƒæ‰‹ï¼š
$$
\max\sum_{i=1}^mb_i\\
\text{s.t.}\quad a_i\le 1\\
b_i\le 1\\
b_i\le \sum_{j\in[l_i,r_i]}a_j\\
\sum_{i=1}^na_i\le k\\
a_i,b_i\ge 0
$$
é¦–å…ˆæ•´ç†æ‰€æœ‰é™åˆ¶
$$
\max\sum_{i=1}^mb_i\\
\text{s.t.}\quad a_i-1\le 0\\
b_i-1\le 0\\
b_i-\sum_{j\in[l_i,r_i]}a_j\le 0\\
\sum_{i=1}^na_i-k\le 0\\
a_i,b_i\ge 0
$$
å¼•å…¥ $\lambda=\{x,y,z,t\}$ å¹¶å¾—åˆ° $L(x,\lambda)$ å’Œ $\lambda$ çš„ç‰¹æ®Šé™åˆ¶
$$
L(x,\lambda)=\sum_{i=1}^mb_i+\sum_{i=1}^nx_i(a_i-1)+\sum_{i=1}^my_i(b_i-1)+\sum_{i=1}^mz_i(b_i-\sum_{j\in[l_i,r_i]}a_j)+t(\sum_{i=1}^na_i-k)\\
x_i,y_i,z_i,t\le 0
$$
æå– $a_i$ å’Œ $b_i$ çš„ç³»æ•°å¹¶å˜æ¢ä¸»å…ƒ
$$
L(x,\lambda)=\sum_{i=1}^na_i(x_i-\sum_{i\in[l_j,r_j]}z_j+t)+\sum_{i=1}^mb_i(y_i+z_i+1)-\sum_{i=1}^nx_i-\sum_{i=1}^ny_i-kt
$$
è€ƒè™‘ $\min_{\lambda}\max_x$ï¼Œç”±æ­¤å¾—åˆ° $\lambda$ çš„é™åˆ¶å’Œæ–°çš„æœ€ä¼˜åŒ–ç›®æ ‡ã€‚å¯¹å¶åçš„ç»“æœå¦‚ä¸‹
$$
\min_{\lambda}-\sum_{i=1}^nx_i-\sum_{i=1}^ny_i-kt\\
\text{s.t.}\quad x_i-\sum_{i\in[l_j,r_j]}z_j+t\le 0\\
y_i+z_i+1\le 0\\
x_i,y_i,z_i,t\le 0
$$
éƒ½æ˜¯è´Ÿæ•°ï¼Œå…¨éƒ¨å–åä¸€ä¸‹å¯ä»¥å¾—åˆ°æ›´å¥½çœ‹çš„å½¢å¼
$$
\min_{\lambda}\sum_{i=1}^nx_i+\sum_{i=1}^ny_i+kt\\
\text{s.t.}\quad x_i+t\ge \sum_{i\in[l_j,r_j]}z_j\\
y_i+z_i\ge 1\\
x_i,y_i,z_i,t\ge 0
$$
è¿™æ ·å¯¹å¶ä¼šèˆ’æœå¾ˆå¤šã€‚

#### åŸé—®é¢˜

å›åˆ°åŸé—®é¢˜ï¼Œç›¸å½“äºï¼Œæœ‰å¾ˆå¤šç§æ“ä½œï¼Œè¦ç»™æ¯ä¸ªæ“ä½œä¸€ä¸ªæƒå€¼ï¼ˆæ“ä½œæ¬¡æ•°ï¼‰ï¼Œæ»¡è¶³ä¸€äº›æ¡ä»¶çš„æƒ…å†µä¸‹æœ€å°åŒ–æƒå€¼å’Œã€‚

ä¸å¦¨è®¾æ‰€æœ‰æ“ä½œçš„é›†åˆï¼ˆä¿®æ”¹çš„åŒºé—´ä¸åŒä¹Ÿè§†ä½œæ“ä½œä¸åŒï¼‰ä¸º $S$ï¼Œè®¾ä¸€ä¸ªæ“ä½œ $i$ çš„æ“ä½œä¸‹æ ‡é›†åˆä¸º $O_i$
$$
\min_x\sum_{i\in S}x_i\\
\text{s.t.}\quad a_i=\sum_{j\in S,i\in O_j}x_j\\
x_i\ge 0
$$
ç›´æ¥å°†å…¶å¤§åŠ›å¯¹å¶ã€‚æ•´ç†å½¢å¼
$$
\min_x\sum_{i\in S}x_i\\
\text{s.t.}\quad \sum_{j\in S,i\in O_j}x_j-a_i=0\\
x_i\ge 0
$$
å¼•å…¥ $\lambda$ã€‚å› ä¸ºæ˜¯ç­‰å¼é™åˆ¶ï¼Œæ‰€ä»¥ $\lambda$ æ— ç‰¹æ®Šé™åˆ¶
$$
L(x,\lambda)=\sum_{i\in S}x_i+\sum_{i=1}^n\lambda_i(\sum_{j\in S,i\in O_j}x_j-a_i)\\
$$
å˜æ¢ä¸»å…ƒ
$$
L(x,\lambda)=\sum_{i\in S}x_i(\sum_{j\in O_i}\lambda _j+1)-\sum_{i=1}^n\lambda _ia_i
$$
è®¡ç®—å‡ºæ–°çš„çº¦æŸä¸æœ€ä¼˜åŒ–ç›®æ ‡ï¼Œå¾—åˆ°å¯¹å¶ç»“æœ
$$
\max_{\lambda}-\sum_{i=1}^n\lambda _ia_i\\
\sum_{j\in O_i}\lambda _j+1\ge 0\\
$$
å…¨éƒ¨å–å
$$
\max_{\lambda}\sum_{i=1}^n\lambda _ia_i\\
\sum_{j\in O_i}\lambda _j\le 1\\
$$
è¿™å½¢å¼è¶…å¥½çœ‹ ğŸ˜°ï¸

é—®é¢˜å˜æˆï¼Œæˆ‘ä»¬è¦ç»™æ¯ä¸ªä½ç½®åˆ†é…ä¸€ä¸ªæƒå€¼ï¼Œæ»¡è¶³å¯¹äºæ‰€æœ‰å¯èƒ½çš„æ“ä½œï¼Œæ“ä½œä½ç½®çš„æƒå€¼å’Œä¸è¶…è¿‡ $1$ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæœ€å¤§åŒ–åºåˆ—çš„æƒå€¼ä¸ $a_i$ çš„ä¹˜ç§¯ã€‚

é¦–å…ˆå‡è£…æ‰€æœ‰ $\lambda$ éƒ½å–æ•´æ•°ã€‚

æ˜¾ç„¶å­˜åœ¨å•ç‚¹çš„æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬æœ‰ $\lambda \le 1$

è¿›ä¸€æ­¥åœ°ï¼Œ$\lambda\le -2$ ä¹Ÿæ˜¯ä¸å¯èƒ½çš„ã€‚

è€ƒè™‘åè¯æ³•ï¼Œè‹¥ä¸€ä¸ª $\lambda_i$ åœ¨æœ€ä¼˜æƒ…å†µä¸‹å–äº† $\le-2$ï¼Œè¿™æ„å‘³ç€ä¸€å®šå­˜åœ¨ä¸€ä¸ªåŒ…å« $i$ çš„åŒºé—´ï¼Œæ»¡è¶³åŒºé—´å’Œæ­£å¥½ä¸º $1$ï¼Œå¦åˆ™ $\lambda$ å¯ä»¥å‘ä¸Šè°ƒæ•´ã€‚ä¸å¦¨å–ä¸€ä¸ªè¿™æ ·çš„åŒºé—´ä¸º $[L,R]$ã€‚

ç„¶è€Œæˆ‘ä»¬å‘ç°è¿™æ ·çš„ $[L,R]$ æ˜¯ä¸å¯èƒ½å­˜åœ¨çš„ï¼Œå› ä¸º $[L,i-1]$ çš„åŒºé—´å’Œ $\le 1$ï¼Œ$[i+1,R]$ çš„åŒºé—´ä¹Ÿå’Œ $\le 1$ï¼Œé‚£ä¹ˆ $[L,R]$ åŒºé—´å’Œçš„å–å€¼èŒƒå›´å°±ä¸º $\le 1+1-2=0$ï¼Œæ˜¯ä¸å¯èƒ½å–åˆ° $1$ çš„ã€‚

æ‰€ä»¥æˆ‘ä»¬æŠŠ $\lambda$ çš„èŒƒå›´é™åˆ¶åœ¨äº† $\{-1,0,1\}$ é‡Œã€‚äºæ˜¯ç°åœ¨å°±å¯ä»¥è€ƒè™‘ DP äº†ã€‚

ä¸€ä¸ªå¾ˆæš´åŠ›çš„çŠ¶æ€è®¾è®¡æ˜¯ $f_{i,X,Y,Z}$ è¡¨ç¤ºè€ƒè™‘äº†å‰ $i$ ä¸ªä½ç½®ï¼Œæ¯ä¸ªåç¼€çš„åç¼€å’Œã€åç¼€å¥‡ä½ç½®å’Œã€åç¼€å¶ä½ç½®å’Œ**çš„é›†åˆ**åˆ†åˆ«ä¸º $X,Y,Z$ï¼Œè½¬ç§»å°±è€ƒè™‘ $\lambda _i+1$ çš„å–å€¼ï¼ŒæŠŠæ–°çš„å–å€¼åŠ å…¥ $XYZ$ åä¿è¯é›†åˆçš„æœ€å¤§å€¼æ—¶åˆ»ä¸è¶…è¿‡ $1$ å³å¯è½¬ç§»ã€‚è¿™ä¸ª DP çš„çŠ¶æ€æ•°æ˜¯éå¸¸çˆ†ç‚¸çš„ $O(n^n)$

ç„¶åç«‹é©¬å‘ç°æˆ‘ä»¬åªé™åˆ¶é›†åˆæœ€å¤§å€¼ï¼Œä¸”æ¯æ¬¡æ“ä½œå½¢å¦‚ç»™é›†åˆåŠ å…¥ä¸€ä¸ªæ•°ï¼Œæˆ–ç»™æ•´ä¸ªé›†åˆåŠ ä¸Šä¸€ä¸ªå€¼ã€‚è¿™æ ·çš„æ“ä½œæ˜¯ä¸ä¼šå½±å“å…ƒç´ çš„ç›¸å¯¹é¡ºåºçš„ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥åªè®°å½•é›†åˆæœ€å¤§å€¼ï¼Œè®¾ $f_{i,x,y,z}$ è¡¨ç¤ºè€ƒè™‘å‰ $i$ ä¸ªä½ç½®ï¼Œæœ€å¤§åç¼€å’Œã€æœ€å¤§åç¼€å¥‡ä½ç½®å’Œã€æœ€å¤§åç¼€å¶ä½ç½®å’Œåˆ†åˆ«æ˜¯ $x,y,z$ï¼Œèƒ½å¾—åˆ°æœ€å¤§çš„ $\sum_{j=1}^i\lambda _ja_j$ æ˜¯å¤šå°‘ã€‚é›†åˆæœ€å¤§å€¼çš„å–å€¼åªæœ‰ $\{-1,0,1\}$ï¼Œç›´æ¥è½¬ç§»å³å¯ï¼Œå¤æ‚åº¦ $O(n)$

> è¿™é‡Œå¯¹å¶ï¼Œå› ä¸ºå˜é‡å¤šï¼Œé™åˆ¶å°‘ã€‚å¯¹å¶åå˜é‡å°‘ï¼Œé™åˆ¶å¤šï¼Œä½†é™åˆ¶æ˜¯å…·æœ‰æ€§è´¨å¯ä»¥åˆ†æçš„ï¼Œä»è€Œè®©é—®é¢˜æ›´å¯åš

```
int n;
int a[MAXN];
void solve(bool SPE){ 
	n=RIN;
	foru(i,1,n){
		a[i]=RIN;
	}

	static LL f[MAXN][4][4][4];
	
	foru(i,0,n){
		foru(x,-1,1){
			foru(y,-1,1){
				foru(z,-1,1){
					f[i][x+1][y+1][z+1]=-1e15;
				}
			}
		}
	}
	f[0][0][0][0]=0;
	foru(i,0,n-1){
		foru(x,-1,1){
			foru(y,-1,1){
				foru(z,-1,1){
					foru(k,-1,1){
						chkmax(f[i+1][max(x+k,k)+1][(i&1)?max(y+k,k)+1:y+1][(i&1)?z+1:max(z+k,k)+1],f[i][x+1][y+1][z+1]+k*a[i+1]);
					}
				}
			}
		}
	}
	LL ans=LLONG_MIN;
	foru(x,-1,1){
		foru(y,-1,1){
			foru(z,-1,1){
				chkmax(ans,f[n][x+1][y+1][z+1]);
			}
		}
	}
	cout<<ans<<endl;
	return ;
}
```



# CF1753E

æ‚¨å·²è¢«é‚€è¯·ä½œä¸ºç”Ÿäº§è¿‡ç¨‹ä¼˜åŒ–ä¸“å®¶åŠ å…¥ä¸€å®¶éå¸¸å¤§çš„å…¬å¸ã€‚è¯¥å…¬å¸åœ¨å·¥å‚ä¸­æœ‰$n$å°æœºå™¨ï¼ŒæŒ‰ç”Ÿäº§é“¾ä¾æ¬¡æ’åˆ—ã€‚æ¯å°æœºå™¨å¯ä»¥ç”¨ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€æè¿°ï¼š$(+,~a_i)$æˆ–$(*,~a_i)$ã€‚

å¦‚æœå°†ä»·å€¼ä¸º$x$çš„å·¥ä»¶è¾“å…¥åˆ°ç±»å‹ä¸º$(+,~a_i)$çš„æœºå™¨ä¸­ï¼Œåˆ™è¾“å‡ºçš„å·¥ä»¶ä»·å€¼ä¸º$x + a_i$ã€‚

å¦‚æœå°†ä»·å€¼ä¸º$x$çš„å·¥ä»¶è¾“å…¥åˆ°ç±»å‹ä¸º$(*,~a_i)$çš„æœºå™¨ä¸­ï¼Œåˆ™è¾“å‡ºçš„å·¥ä»¶ä»·å€¼ä¸º$x \cdot a_i$ã€‚

æ•´ä¸ªç”Ÿäº§è¿‡ç¨‹å¦‚ä¸‹ã€‚å°†ä»·å€¼ä¸º$1$çš„å·¥ä»¶è¾“å…¥åˆ°ç¬¬ä¸€å°æœºå™¨ï¼Œç„¶åå°†ç¬¬ä¸€å°æœºå™¨æ“ä½œåå¾—åˆ°çš„å·¥ä»¶è¾“å…¥åˆ°ç¬¬äºŒå°æœºå™¨ï¼Œç„¶åå°†ç¬¬äºŒå°æœºå™¨æ“ä½œåå¾—åˆ°çš„å·¥ä»¶è¾“å…¥åˆ°ç¬¬ä¸‰å°æœºå™¨ï¼Œä¾æ­¤ç±»æ¨ã€‚ç”±äºå…¬å¸è¡¨ç°ä¸ä½³ï¼Œå› æ­¤ç°åœ¨ç”Ÿæˆäº§å“çš„ä»·å€¼ä¸è¶…è¿‡$2 \cdot 10^9$ã€‚

å…¬å¸çš„è‘£äº‹ä»¬å¯¹ç”Ÿäº§è¿‡ç¨‹çš„æ•ˆç‡ä¸æ»¡æ„ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªä¸ºä¼˜åŒ–ç”Ÿäº§è¿‡ç¨‹çš„é¢„ç®—$b$ä¸ªç¡¬å¸ã€‚

ä¸ºäº†ä¼˜åŒ–ç”Ÿäº§ï¼Œæ‚¨å¯ä»¥æ”¹å˜é“¾ä¸­æœºå™¨çš„é¡ºåºã€‚å³ï¼Œé€šè¿‡èŠ±è´¹$p$ä¸ªç¡¬å¸ï¼Œæ‚¨å¯ä»¥å°†ä»»ä½•ç±»å‹ä¸º$(+,~a_i)$çš„æœºå™¨ç§»åŠ¨åˆ°é“¾ä¸­çš„ä»»ä½•ä½ç½®ï¼Œè€Œä¸æ”¹å˜å…¶ä»–æœºå™¨çš„é¡ºåºã€‚æ­¤å¤–ï¼Œé€šè¿‡èŠ±è´¹$m$ä¸ªç¡¬å¸ï¼Œæ‚¨å¯ä»¥å°†ä»»ä½•ç±»å‹ä¸º$(*,~a_i)$çš„æœºå™¨ç§»åŠ¨åˆ°é“¾ä¸­çš„ä»»ä½•ä½ç½®ã€‚

$1 \le n \le 10^6$ï¼Œ$1 \le b, p, m \le 10^9,1 \le a_i \le 2 \cdot 10^9$ã€‚

ä¿è¯äº§å‡ºäº§å“çš„å½“å‰å€¼ä¸è¶…è¿‡$2 \cdot 10^9$

### æ€è€ƒ

å¦‚æœç§»åŠ¨åŠ æ³•ï¼Œè‚¯å®šæ˜¯ç§»åŠ¨åˆ°å¼€å¤´ï¼Œè¿™æ ·èƒ½åƒåˆ°æ›´å¤šä¹˜æ³•çº¢åˆ©

å¦‚æœç§»åŠ¨ä¹˜æ³•ï¼Œè‚¯å®šç§»åŠ¨åˆ°æœ«å°¾ï¼Œè¿™æ ·èƒ½å¢å¹…æ›´å¤šåŠ æ³•

åŸåºåˆ—çš„å€¼ä¸è¶…è¿‡ 2e9ï¼Œå› æ­¤å»æ‰æ‰€æœ‰ $(*,1)$ å‰©ä¸‹çš„ä¹˜æ³•æ•°é‡æ˜¯ $\log V$ çš„ã€‚

ç›´æ¥æšä¸¾ä¼šç§»åŠ¨å“ªäº›ä¹˜æ³•ï¼Ÿå¹¶éï¼Œä¼šç›´æ¥çˆ†

æŠŠä¸€ä¸ªåŠ æ³•ç§»åŠ¨çš„æ”¶ç›Šæ˜¯å®ƒå‰é¢æ‰€æœ‰æœªè¢«ç§»åŠ¨çš„ä¹˜æ³•ä¹‹ç§¯å‡ä¸€ä¹˜ä¸Šå®ƒè‡ªå·±

è¿˜éœ€è¦æ›´å¤šæ€§è´¨

ç§»åŠ¨åŠ æ³•çš„è¿‡ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œå–å‰è‹¥å¹²å¤§å³å¯ï¼Œåœ¨ä¹˜æ³•å›ºå®šçš„æƒ…å†µä¸‹

å¯¹äºä¹˜æ³•æœºå™¨ä¹‹é—´çš„æŸæ®µåŠ æ³•ï¼Œä¼˜å…ˆæŒªåŠ¨ $a_i$ å¤§çš„ï¼Œæ­£ç¡®æ€§æ˜¾ç„¶ã€‚

### é¢˜è§£

ä¸Šé¢çš„æ€è·¯æ­£ç¡®

æœ‰ä¸€ä¸ªå…³é”®æ€§è´¨æ˜¯ï¼š

è€ƒè™‘ä¸¤ä¸ªç›¸åŒçš„ä¹˜æ³•æœºå™¨ï¼Œ**é€‰æ‹©åé¢çš„å‰ææ˜¯å‰é¢ä¹Ÿè¢«é€‰æ‹©**ï¼Œå¦åˆ™é€‰æ‹©å‰é¢æ›´ä¼˜ã€‚

è¿™å°±è®©é€‰æ‹©ä¹˜æ³•çš„çŠ¶æ€æ•°å˜å¾—å°‘äº†å¾ˆå¤šï¼Œå¦‚æœè¯•å›¾é¿å…å‡ºç°é‡å¤ä¹˜æ³•æœºå™¨ï¼Œåˆ™ä¹˜æ³•æœºå™¨çš„æ•°é‡ä¼šå°‘å¾ˆå¤šï¼Œå½¢å¦‚ $2\times 3\times 4\cdots$ã€‚ä¸å¦¨è®¾è¿™æ ·çš„çŠ¶æ€æ•°é‡ä¸º $N$ã€‚åˆ™ç°åœ¨æœ‰äº†ä¸€ä¸ª $O(Nn\log n)$ çš„åšæ³•ï¼Œæšä¸¾æ‰€æœ‰åŠ æ³•ï¼Œç®—å‡ºæƒå€¼åæ’åºå–å‰ç¼€ã€‚

è€ƒè™‘ç”¨ä¸Šåˆšæ‰æœ€åè§‚å¯Ÿåˆ°çš„é‚£ä¸ªæ€§è´¨æ¥ä¼˜åŒ–æ‰ $O(n\log n)$ çš„åŠ æ³•å¤„ç†éƒ¨åˆ†ã€‚

ä¹˜æ³•æœºå™¨åˆ†å‰²å‡ºæ¥çš„æ®µæ•°æ˜¯ $O(\log V)$ çš„ï¼Œè€Œæ ¹æ®æ€§è´¨ï¼Œæ¯æ®µå†…éƒ¨é€‰æ‹©çš„ $a_i$ è‚¯å®šæ˜¯é™åºæ’åºåçš„æŸä¸ªå‰ç¼€ã€‚

äºæ˜¯åœ¨å€¼åŸŸä¸ŠäºŒåˆ†ä¸€ä¸ª $mid$ ï¼Œå»å¯¹æ¯ä¸€æ®µè®¡ç®—è¿™æ ·ä¼šå–èµ°å¤šå°‘ä¸ª $a_i$ï¼Œä»¥åŠå®ƒä»¬çš„è´¡çŒ®å’Œï¼Œè®¡ç®—å‡ºæ•°é‡åˆæ³•çš„æœ€å¤§è´¡çŒ®å³å¯ã€‚å¤æ‚åº¦ $O(N\log V\log n)$

```
int n;
LL b,p,m;
class OPT{
public:
	int ty;
	LL v;
}a[MAXN];

unordered_map<int,vector<int>> mls;
vector<int> als[MAXN];
vector<LL> sls[MAXN];
vector<int> ls;

bitset<MAXN> us;

LL ans=LLONG_MIN;

void calc(){
	int N=0;
	for(auto i:ls){
		N+=us[i];
	}
	// cerr<<' '<<N<<endl;
	if(N*m>b)	return ;

	
	LL cur=0;
	{
		LL suf=1;
		for(auto i:ls){
			suf*=a[i].v;
		}
		cur+=sls[0].back()*suf;
		for(auto i:ls){
			if(!us[i])	suf/=a[i].v;
			if(!sls[i].empty()){
				cur+=sls[i].back()*suf;
			}
		}
	}


	int res=(b-N*m)/p;
	LL L=-3e18,R=3e18,mx=0;
	while(L<=R){
		LL Mid=(L+R)/2;
		LL Sum=0;
		int Num=0;
		int Add=0;
		// if(N==0){
		// 	cerr<<"BS"<<' '<<Mid<<' '<<L<<' '<<R<<endl;
		// }

		LL pre=1;
		LL suf=1;
		for(auto i:ls){
			suf*=a[i].v;
		}
		for(auto i:ls){
			if(!us[i])	pre*=a[i].v,suf/=a[i].v;
			if(!sls[i].empty()){
				int num=0;
				LL sum=0;
				int add=0;
				{
					int l=0,r=sls[i].size()-1;
					while(l<=r){
						int mid=(l+r)>>1;
						if(als[i][mid]*(pre-1)*suf>Mid){
							num=mid+1;
							sum=sls[i][mid];
							l=mid+1;
						}else{
							r=mid-1;
						}
					}
				}
				{
					int l=0,r=sls[i].size()-1;
					while(l<=r){
						int mid=(l+r)>>1;
						if(als[i][mid]*(pre-1)*suf>=Mid){
							add=mid+1;
							l=mid+1;
						}else{
							r=mid-1;
						}
					}
					add-=num;
				}
				
				// if(N==0){
				// 	cerr<<i<<' '<<num<<endl;
				// }
				Num+=num;
				Add+=add;
				Sum+=sum*(pre-1)*suf;
			}
		}

		Sum+=min(Add,res-Num)*Mid;
		if(Num<=res){
			// assert(Sum>=mx);
			mx=Sum;
			// chkmax(mx,Sum);
			R=Mid-1;
		}else{
			L=Mid+1;
		}
	}

	// cerr<<res<<endl;
	// cerr<<cur<<endl;
	// if(N==0){
	// 	cerr<<cur<<' '<<mx<<endl;
	// }
	chkmax(ans,cur+mx);
}

void dfs(unordered_map<int,vector<int>>::iterator it){
	if(it==mls.end()){
		calc();
		return ;
	}
	for(auto i:it->se){
		us[i]=1;
	}
	dfs(next(it));
	ford(i,(int)it->se.size()-1,0){
		us[it->se[i]]=0;
		dfs(next(it));
	}
}

void solve(bool SPE){ 
	n=RIN,b=RIN,p=RIN,m=RIN;

	als[0]+=1;
	int lst=0;
	foru(i,1,n){
		char c=RCIN;
		if(c=='+'){
			a[i].ty=0;
		}else{
			a[i].ty=1;
		}
		a[i].v=RIN;

		if(a[i].ty==1 && a[i].v==1)	continue;

		if(a[i].ty){
			lst=i;
			ls+=i;
		}
		if(a[i].ty){
			mls[a[i].v]+=i;
		}else{
			als[lst]+=a[i].v;
		}
	}

	auto process=[](vector<int>& X,vector<LL>& S)->void {
		S.clear();
		if(X.empty())	return ;
		S.resize(X.size(),0);
		sort(All(X),[](int x,int y)->bool {
			return x>y;
		});
		S[0]=X[0];
		for(size_t i=1;i<X.size();i++){
			S[i]=S[i-1]+X[i];
		}
	};
	process(als[0],sls[0]);
	for(auto i:ls){
		process(als[i],sls[i]);
	}

	dfs(mls.begin());

	cout<<ans;

	return ;
}
```

# P5170 & ä¸‡èƒ½æ¬§å‡ é‡Œå¾·ç®—æ³•

### ä¸‡æ¬§èƒ½å¹²ä»€ä¹ˆ

ä¸‡æ¬§å¯ä»¥åšè¿™ä»¶äº‹ï¼š

æˆ‘ä»¬æœ‰ä¸¤ç§æ“ä½œï¼Œ$U$ å’Œ $R$ã€‚

å¯¹äºä¸€æ¡ $y=\dfrac{ax+b}{c},x\in(0,n]ï¼Œa,b,c\ge 0$ çš„ç›´çº¿ï¼Œè€ƒè™‘ä»å·¦å¾€å³åœ¨è¿™æ¡ç›´çº¿ä¸Šè¡Œèµ°ï¼Œå¹¶æ„é€ è¿™æ ·ä¸€ä¸ªæ“ä½œåºåˆ—ï¼š

- è¡¥å…… $\lfloor\frac{b}{c}\rfloor$ ä¸ª $U$
- å¦‚æœæ’ä¸Šæ•´æ ¼æ°´å¹³çº¿ï¼Œæ·»åŠ  $U$
- å¦‚æœæ’ä¸Šæ•´æ ¼å‚ç›´çº¿ï¼Œæ·»åŠ  $R$
- å¦‚æœåŒæ—¶æ’ä¸Šä¸¤è€…ï¼Œå³ç»è¿‡äº†ä¸€ä¸ªæ•´ç‚¹ï¼Œæ·»åŠ  $UR$

å¯¹äºè¿™æ ·ä¸€ä¸ªæ“ä½œåºåˆ—ï¼Œæˆ‘ä»¬éœ€è¦æ±‚å‡ºä¾æ¬¡æ‰§è¡Œæ¯ä¸ª $U$ å’Œ $R$ åçš„ç»“æœã€‚

è§†æ“ä½œä¸ºå…ƒç´ ï¼Œå¹¶å‡è®¾æ“ä½œå¤æ‚åº¦ä¸º $O(1)$ï¼Œåˆ™æš´åŠ›ä¾æ¬¡æ“ä½œçš„å¤æ‚åº¦ä¸º $O(n)$ã€‚

å¦‚æœå…ƒç´ ä¹‹é—´æœ‰ç»“åˆå¾‹ï¼Œç±»ä¼¼å¿«é€Ÿå¹‚ï¼Œä¸‡æ¬§å¯ä»¥åœ¨ $O(\log(\max(a,c))+\log(\frac{b}{c}))$ çš„å¤æ‚åº¦å†…æ±‚å‡ºç»“æœ

### ä¸‡æ¬§çš„æµç¨‹

ä¸å¦¨è®¾è®¡ç®—ä¸Šè¿°å¼å­çš„å‡½æ•°ä¸º $\text{calc}(a,b,c,n,U,R)$ã€‚ä¸‡æ¬§çš„ç®—æ³•æµç¨‹å¦‚ä¸‹

é¦–å…ˆåˆ¤æ–­æ˜¯å¦ $b\ge c$ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥è¿”å›ï¼š
$$
U^{\lfloor\frac{b}{c}\rfloor}\text{calc}(a,b\bmod c,c,n,U,R)
$$
è¿™ä¸€æ­¥æ­£ç¡®æ€§æ˜¾ç„¶ï¼Œç›¸å½“äºå…ˆå¤„ç†æ‰å‰é¢çš„è‹¥å¹² $U$ï¼Œå¹¶æŠŠç›´çº¿å‘ä¸‹å¹³ç§»ï¼Œç›´è‡³æˆªè·ä¸è¶³ $1$

å†åˆ¤æ–­æ˜¯å¦ $a\ge c$ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥è¿”å›ï¼š
$$
\text{calc}(a\bmod c,b,c,n,U,U^{\lfloor\frac{a}{c}\rfloor}R)
$$
è¿™ä¸€æ­¥çš„æ­£ç¡®æ€§ä¹Ÿæ˜¯å¥½ç†è§£çš„ï¼Œè€ƒè™‘æ¯ä¸ª $R$ å¤„ï¼Œå®ƒä¸ä¸Šä¸ª $R$ ä¹‹é—´ï¼Œçºµåæ ‡ä¸Šå‡çš„å¤§å°ä¸º $\dfrac{a}{c}$ï¼Œæ‰€ä»¥ä¸€å®šä¼šäº§ç”Ÿ $\lfloor\dfrac{a}{c}\rfloor$ ä¸ª $U$ï¼ŒæŠŠå®ƒä»¬å’Œåé¢çš„ $R$ ä¸€èµ·è€ƒè™‘å³å¯ã€‚è¿™ç›¸å½“äºå¯¹äºæ¯ä¸ª $R$ éƒ½æŠ½æ‰äº†å®ƒä¸‹é¢çš„è‹¥å¹²è¡Œï¼Œä½¿å¾—ç›´çº¿å˜å¾—æ›´å¹³ç¼“ï¼Œä¸Šå‡çš„æ•´æ•°æ ¼éƒ½è¢«æŠ½äº†ï¼Œå› æ­¤æ–œç‡å˜ä¸º $\dfrac{a\bmod c}{c}$ã€‚

ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæˆªè·åœ¨ $[0,1)$ ä¹‹é—´ï¼Œæ–œç‡åœ¨ $[0,1)$ ä¹‹é—´çš„ä¸€æ¡ç›´çº¿ã€‚ä¸‡æ¬§çš„æ€è·¯æ˜¯ï¼ŒæŠŠåæ ‡ç³»çš„ $xy$ äº’æ¢ï¼Œä½¿å¾—ç›´çº¿é‡æ–°å˜å¾—é™¡å³­ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨ä¸Šé¢çš„ç®—æ³•å¤„ç†ã€‚

å…ˆè€ƒè™‘æ–°è¯¢é—®çš„ $n'$ æ˜¯å¤šå°‘ï¼Œå³å¯¹åº”å½“å‰è¯¢é—®é‡Œæœ‰å¤šå°‘ $U$ã€‚è¿™æ˜¯å¯ä»¥è®¡ç®—çš„ï¼š
$$
n'=\lfloor\frac{an+b}{c}\rfloor
$$
ç„¶åæˆ‘ä»¬å°è¯•æ±‚å‡ºä¸€ä¸ª $U$ å‰é¢æœ‰å¤šå°‘ $R$ã€‚

å¯¹äºç¬¬ $i$ ä¸ª $U$ï¼Œå®ƒå‰é¢ $R$ çš„æ•°é‡å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªæœ€å¤§çš„ $j$ï¼Œä½¿å¾—ï¼š
$$
\lfloor\frac{aj+b}{c}\rfloor<i\\
\frac{aj+b}{c}<i\\
j<\frac{ci-b}{a}\\
j<\lceil\frac{ci-b}{a}\rceil\\
j<\lfloor\frac{ci-b-1}{a}\rfloor+1\\
$$
å› æ­¤ $j=\lfloor\dfrac{ci-b-1}{a}\rfloor$ã€‚æ‰€ä»¥é€’å½’åˆ° $\text{calc}(c,-b-1,a,n',R,U)$ï¼Ÿ

å®åˆ™å¹¶éï¼Œè¿˜æœ‰å¾ˆå¤šç»†èŠ‚ã€‚è¿™é‡Œå‘ç°æˆªè·å˜æˆè´Ÿçš„äº†ï¼Œéœ€è¦å¤„ç†ä¸€ä¸‹ ã€‚å‘ç°åªè¦ä» $c_i$ é‡ŒåŒ€ä¸€ä¸ª $c$ å‡ºæ¥å°±èƒ½ä¿è¯éè´Ÿï¼Œäºæ˜¯å…ˆæå‰æŠŠç¬¬ä¸€ä¸ª $U$ å’Œå®ƒä¹‹å‰çš„ $R$ å…¨éƒ¨å¤„ç†æ‰ã€‚å¤´éƒ¨ä¸€å…±æœ‰ $\lfloor\dfrac{c-b-1}{a}\rfloor$ ä¸ª $R$ã€‚å› æ­¤ç¬¬ $i$ ä¸ª $U$ å‰é¢ $R$ çš„æ•°é‡å˜æˆï¼š
$$
\lfloor\dfrac{c(i+1)-b-1}{a}\rfloor-\lfloor\dfrac{c-b-1}{a}\rfloor=\lfloor\dfrac{ci+(c-b-1)\bmod a}{a}\rfloor
$$

>è¯æ˜
>$$
>\lfloor\frac{A+B}{C}\rfloor-\lfloor\frac{B}{C}\rfloor\\
>=\lfloor\frac{A+\lfloor\frac{B}{C}\rfloor C+B\bmod C}{C}\rfloor-\lfloor\frac{\lfloor\frac{B}{C}\rfloor C+B\bmod C}{C}\rfloor\\
>=\lfloor\frac{A+B\bmod C}{C}+\lfloor\frac{B}{C}\rfloor\rfloor-\lfloor\frac{B\bmod C}{C}+\lfloor\frac{B}{C}\rfloor\rfloor\\
>=\lfloor\frac{A+B\bmod C}{C}\rfloor-\lfloor\frac{B\bmod C}{C}\rfloor\\
>=\lfloor\frac{A+B\bmod C}{C}\rfloor\\
>$$
>

åŒæ—¶ï¼Œæœ€åä¸€ä¸ª $U$ åé¢çš„ $R$ ä¹Ÿéœ€è¦å¤„ç†æ‰ã€‚æ•°é‡æ˜¯ $n-\lfloor\dfrac{cn'-b-1}{a}\rfloor$ã€‚

å› æ­¤è¿”å›ï¼š
$$
R^{\lfloor\frac{c-b-1}{a}\rfloor}U\text{calc}(c,(c-b-1)\bmod a,a,n'-1,R,U)R^{\lfloor\frac{cn'-b-1}{a}\rfloor}
$$
ç‰¹åˆ«å¤„ç† $n'=0$ çš„æƒ…å†µï¼Œè¿™æ„å‘³ç€ä¸å­˜åœ¨ä»»ä½• $U$ï¼Œç›´æ¥è¿”å› $R^n$ å³å¯ã€‚è¿™ä¹Ÿæ˜¯ä¸‡æ¬§å”¯ä¸€çš„é€’å½’ç»ˆç‚¹

```
namespace Euclid{
	template<class T>
	T qpow(T a,int b){
		T ret;
		while(b){
			if(b&1)	ret=ret*a;
			a=a*a,b>>=1;
		}
		return ret;
	}
	template<class T>
	T calc(LL a,LL b,LL c,LL n,const T& U,const T& R){
		if(b>=c)	return qpow(U,b/c)*calc(a,b%c,c,n,U,R);
		if(a>=c)	return calc(a%c,b,c,n,U,qpow(U,a/c)*R);
		auto m=(a*n+b)/c;
		if(m==0)	return qpow(R,n);
		return qpow(R,(c-b-1)/a)*U*calc(c,(c-b-1)%a,a,m-1,R,U)*qpow(R,n-(c*m-b-1)/a);
	}
}
```

### P5170

å¯¹äºåŸé—®é¢˜ï¼Œç›´æ¥è®¾è®¡ä¿¡æ¯ $(x,y,sy,sxy,sy2)$ï¼Œå¦ $U=(0,1,0,0,0)$ï¼Œ$V=(1,0,0,0,0)$ï¼Œè®¨è®ºè½¬ç§»å³å¯ï¼Œè¿™ä¸ä¸‡æ¬§æ— å…³äº†ã€‚

```
class Info{
public:
	int x;
	int y;
	int sy;
	int sxy;
	int sy2;
	Info(int x=0,int y=0,int sy=0,int sxy=0,int sy2=0):x(x),y(y),sy(sy),sxy(sxy),sy2(sy2){}
	Info operator * (const Info& o)const{
		return Info(
			add(x,o.x),
			add(y,o.y),
			add(sy,o.sy,mul(y,o.x)),
			add(
				sxy,
				mul(x,y,o.x),
				o.sxy,
				mul(x,o.sy),
				mul(y,add(1,o.x),o.x,_2)
			),
			add(
				sy2,
				mul(o.x,y,y),
				o.sy2,
				mul(2,y,o.sy)
			)
		);
	}
};
```

